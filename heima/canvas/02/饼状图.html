<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        canvas {
            display: block;
            margin: 100px auto;
        }
    </style>
</head>

<body>
    <canvas width="600" height="600"></canvas>
    <script>
        // 1.获取元素
        const PieChart = function (ctx) {
            this.ctx = ctx || document.querySelector('canvas').getContext('2d');
            this.w = this.ctx.canvas.width;
            this.h = this.ctx.canvas.height;
            this.x0 = this.w / 2 + 60;
            this.y0 = this.h / 2;
            // 半径
            this.radius = 150;
            // 伸出线长
            this.outline = 20;
            // 矩形框
            this.rectW = 30;
            this.rectH = 16;
            this.space = 20;

        }

        PieChart.prototype.init = function (data) {
            this.drawPie(data);
        }
        PieChart.prototype.drawPie = function (data) {
            // 转换弧度
            const angleList = this.transformAngle(data);
            // 绘制饼图
            let startAngle = 0;
            angleList.forEach((item, i) => {
                let endAngle = startAngle + item.angle;
                this.ctx.beginPath();
                this.ctx.moveTo(this.x0, this.y0);
                this.ctx.arc(this.x0, this.y0, this.radius, startAngle, endAngle);
                const color = this.ctx.fillStyle = this.getRandomColor();
                this.ctx.fill();
                this.drawTitle(startAngle, item.angle, color, item.title);
                this.drawDesc(i, item.title)
                startAngle = endAngle;
            });
        };
        PieChart.prototype.drawTitle = function (startAngle, angle, color, title) {
            /*
             * 1. 确定伸出去的线 ,通过圆心点 通过伸出的线 确定这个线
             * 2. 确定伸出去的点 需要确定伸出去的线的长度
             * 3. 固定伸出去的线的长度
             * 4. 计算这个点的坐标
             * 5. 需要根据角度和斜边的长度 使用弧度 当前起始弧度 + 对应弧度的一半
             * 6.半径 + 伸出去的长度
             */
            const edge = this.radius + this.outline; // 斜边
            const edgeX = Math.cos(startAngle + angle / 2) * edge; // 线的坐标 基于圆心
            const edgeY = Math.sin(startAngle + angle / 2) * edge;
            const outX = this.x0 + edgeX; // 在画布的坐标
            const outY = this.y0 + edgeY;


            this.ctx.beginPath();
            this.ctx.moveTo(this.x0, this.y0);
            this.ctx.lineTo(outX, outY);
            this.ctx.strokeStyle = color;
            // 线的方向
            this.ctx.font = '19px Microsoft YaHei';
            const textWidth = this.ctx.measureText(title).width;
            if (outX > this.x0) {
                // 右边
                this.ctx.lineTo(outX + textWidth, outY);
                this.ctx.textAlign = 'left';
            } else {
                // 
                this.ctx.lineTo(outX - textWidth, outY);
                this.ctx.textAlign = 'right';
            };

            this.ctx.stroke();
            this.ctx.textBaseline = 'bottom';
            this.ctx.fillText(title, outX, outY);




        }
        PieChart.prototype.drawDesc = function (index, title) {
            /*
             * 1.矩形的后置
             * 2. 坐标选择
             * 3.
             */

            this.ctx.fillRect(this.space, this.space + index * (this.rectH + this.space), this.rectW, this.rectH)
            this.ctx.beginPath();
            this.ctx.textAlign = 'left';
            this.ctx.textBaseline = 'top';
            this.ctx.font = '16px Microsoft YaHei';
            this.ctx.fillText(title, this.space + this.rectW + this.space, this.space + index * (this.rectH + this.space));
        }
        PieChart.prototype.transformAngle = function (data) {
            let total = 0;
            data.forEach((item) => {
                total += item.num;
            });
            // 计算弧度
            data.forEach((item) => {
                let angle = item.num / total * Math.PI * 2;
                item.angle = angle;
            });
            return data;
        }
        PieChart.prototype.getRandomColor = function () {
            const r = Math.floor(Math.random() * 256);
            const g = Math.floor(Math.random() * 256);
            const b = Math.floor(Math.random() * 256);
            return `rgb(${r},${g},${b})`;
        }

        const data = [{
                title: '10-20岁',
                num: 8
            },
            {
                title: '20-25岁',
                num: 80
            },
            {
                title: '25-30岁',
                num: 40
            },
            {
                title: '30-45岁',
                num: 8
            },
        ];
        const pieChart = new PieChart();
        pieChart.init(data);
    </script>
</body>

</html>